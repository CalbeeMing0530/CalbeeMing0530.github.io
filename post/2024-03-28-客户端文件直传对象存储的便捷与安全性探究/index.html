<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="Ming Blog">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://puming.zone/img/平衡.png">
    <meta property="twitter:image" content="https://puming.zone/img/平衡.png" />
    

    
    <meta name="title" content="客户端文件直传对象存储的便捷与安全性探究" />
    <meta property="og:title" content="客户端文件直传对象存储的便捷与安全性探究" />
    <meta property="twitter:title" content="客户端文件直传对象存储的便捷与安全性探究" />
    

    
    <meta name="description" content="客户端文件直传对象存储到底安不安全？本文带来详细分析">
    <meta property="og:description" content="客户端文件直传对象存储到底安不安全？本文带来详细分析" />
    <meta property="twitter:description" content="客户端文件直传对象存储到底安不安全？本文带来详细分析" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="puming, 浦明, 浦明的博客, Puming Blog, 博客, Web, 云原生, Serverless, Istio, Kubernetes, 微服务, Microservice">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>客户端文件直传对象存储的便捷与安全性探究-浦明的博客</title>

    <link rel="canonical" href="/post/2024-03-28-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%96%87%E4%BB%B6%E7%9B%B4%E4%BC%A0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E7%9A%84%E4%BE%BF%E6%8D%B7%E4%B8%8E%E5%AE%89%E5%85%A8%E6%80%A7%E6%8E%A2%E7%A9%B6/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Ming Blog</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/life">life</a>
                        </li>
                        
                        <li>
                            <a href="/categories/music">music</a>
                        </li>
                        
                        <li>
                            <a href="/categories/photography">photography</a>
                        </li>
                        
                        <li>
                            <a href="/categories/tech">tech</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/books/">BOOKS</a></li>
                    
                        <li><a href="/top/about/">ABOUT</a></li>
                    

                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6.jpg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97" title="云计算">
                            云计算
                        </a>
                        
                        <a class="tag" href="/tags/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8" title="对象存储">
                            对象存储
                        </a>
                        
                        <a class="tag" href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8" title="云安全">
                            云安全
                        </a>
                        
                    </div>
                    <h1>客户端文件直传对象存储的便捷与安全性探究</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                     &#34;Pu Ming&#34;
                             
                            on 
                            Thursday, March 28, 2024
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h1 id="概述">概述</h1>
<p>本文主要探讨企业租赁云服务商的对象存储服务后，客户端直传文件至对象存储的便捷性及安全问题。首先，本文介绍了文件“直传”与“服务端代理上传”的区别，并解释了如何实现文件“直传”。其次，文中探讨了文件“直传”可能存在的安全风险。例如凭证泄露可能导致的对象存储数据泄露和云资源滥用等问题，并对云服务商提供的安全机制进行了分析。最后，笔者提出了一些延伸思考。希望能为读者提供有益建议。</p>
<h2 id="一---为什么选择客户端直传文件至对象存储">一.   为什么选择客户端直传文件至对象存储</h2>
<p>典型C/S架构下，文件“直传”和“服务端代理上传”方式的上传流程如图1，2所示：</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be1.png" alt="img">
    <center><figcaption>图1. 服务端代理上传文件至对象存储流程</figcaption></center>
  </figure>



  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be2.png" alt="img">
    <center><figcaption>图2. 客户端直传文件至对象存储流程</figcaption></center>
  </figure>


以上流程不难看出，服务端代理上传的方式有以下弊端：</p>
<ul>
<li>网络资源浪费。同一份文件需要上传两次；</li>
<li>服务端带宽消耗大。在云服务器上部署服务端时，考虑到高昂的带宽成本，通常会限制带宽。如果有大量用户上传文件到服务端，可能会迅速耗尽带宽资源，导致请求阻塞，从而影响业务的正常运行。</li>
<li>用户需自行实现文件上传业务；</li>
<li>客户端到服务端通信的安全性无法保障。由于不同企业的安全能力不同，缺乏统一的鉴权模式，客户端到服务端的通信可能存在风险。</li>
</ul>
<p>对比服务端代理上传，我们再看看“直传”方式具备哪些优势：</p>
<ul>
<li>由于同一份文件只需上传一次，不会造成额外的网络资源浪费。此外，带宽消耗取决于客户端的带宽大小，因此服务端的压力显著减少；</li>
<li>用户无需自行实现文件上传业务，可将具体操作交由云服务提供商处理（如果上传业务逻辑不复杂，云服务商提供的上传方式基本可以作为参考模板）。例如，阿里云的OSS对象存储服务提供多种上传方式[1]，如图3所示：</li>
</ul>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be3.png" alt="img">
    <center><figcaption>图3. 阿里云OSS对象存储文件上传方式</figcaption></center>
  </figure>

</p>
<ul>
<li>安全性高，云服务商会提供统一的授权模式，如STS令牌、第三方签名URL等，具体内容可见下文分析。</li>
</ul>
<h2 id="二----如何实现客户端直传文件至对象存储">二.    如何实现客户端直传文件至对象存储</h2>
<p>通常情况下，我们使用Web端或小程序作为客户端。由于浏览器实施同源策略的跨域限制，因此无法直接将文件上传至对象存储。要实现“直传”，首先需要解决跨域问题。我们可参考云服务提供商提供的跨域设置，以阿里云的OSS为例，可以针对特定的存储桶进行相应的配置，如图4所置：</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be4.png" alt="img">
    <center><figcaption>图4. 阿里云OSS对象存储跨域配置</figcaption></center>
  </figure>

</p>
<p>解决跨域问题后，将文件上传至对象存储需要获得云服务商的授权。通常情况下，我们可以通过云服务商向用户颁发的AK/SK凭证来获取授权。然而，由于“直传”方式可能会将AK/SK暴露在Web端页面，存在凭证泄漏的风险，因此这种方式并不安全。为降低风险，云服务商提供了多种授权方式，例如阿里云的OSS服务提供STS令牌、第三方服务签名URL、表单上传等方式。</p>
<h2 id="三---客户端直传文件至对象存储的风险分析">三.   客户端直传文件至对象存储的风险分析</h2>
<h3 id="31-云凭证泄漏导致对象存储数据泄漏风险">3.1 云凭证泄漏导致对象存储数据泄漏风险</h3>
<p>文件“直传”过程中，如果用户在客户端Web的HTML页面中硬编码云凭证信息，可能会导致云凭证泄漏风险。攻击者可以利用泄漏的云凭证访问对象存储并窃取数据。云服务商通常提供两种凭证类型：云用户的AK/SK和STS（Security Token Service）临时访问凭证。对于AK/SK类凭证，云服务商通常不强制其过期时间，一旦泄漏且未定期更换，攻击者可持续窃取数据。对于STS临时访问凭证，用户可限制访问权限和有效期，避免长期暴露AK/SK的风险。尽管STS一定上程度上减少了风险，但若用户不遵循最小权限原则或设置过长有效期，仍可能导致数据泄露风险。以阿里云的STS为例，STS凭证只能通过RAM角色获取，用户可设置有效期，最长为12小时。如图5所示：</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be5.png" alt="img">
    <center><figcaption>图5. 阿里云RAM角色设置STS有效时长</figcaption></center>
  </figure>

</p>
<p>即使STS的有效时长被设置为最大值，给予了攻击者更多时间，但若RAM角色仅被授予有限权限，攻击者仍只能在特定权限范围内窃取数据。若权限设置过大，将扩大攻击范围，导致更多云资源数据被窃取，为此我们可以对RAM角色进行授权设置，确保权限范围受控。图6，7展示了如何为RAM角色新增权限以及STS临时凭证所支持的云服务。</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be6.png" alt="img">
    <center><figcaption>图6. 阿里云RAM角色新增授权</figcaption></center>
  </figure>

</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be7.png" alt="img">
    <center><figcaption>图7. 支持STS的云服务</figcaption></center>
  </figure>

</p>
<h3 id="32-云凭证泄漏导致其他云资源被滥用风险">3.2 云凭证泄漏导致其他云资源被滥用风险</h3>
<p>AK/SK和STS云凭证泄漏也会带来其他云资源被滥用的风险。攻击者可以使用泄漏的云凭证和云服务商提供的SDK操作其他云资源，导致资源被滥用。例如，攻击者可以利用云凭证创建Serverless函数并进行滥用。云服务商提供的Serverless函数通常具有免费试用、低部署成本以及可信的访问域名和非唯一的IP等特征，攻击者可将其作为跳板隐藏攻击资产，如图8所示：</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be8.png" alt="img">
    <center><figcaption>图8.Serverless滥用风险</figcaption></center>
  </figure>

</p>
<h2 id="四---客户端直传文件至对象存储授权机制分析">四.   客户端直传文件至对象存储授权机制分析</h2>
<p>客户端直传文件需要对象存储的授权，云服务商提供了多种授权机制以满足用户需求。需注意的是云凭证不应存储在前端，而应由服务端生成签名或临时访问凭证。我们依然以阿里云的OSS举例说明，其提供了三种授权机制：</p>
<ul>
<li><strong>STS临时访问凭证机制</strong>： 服务端生成临时凭证（可设置有效期），返回给客户端。客户端使用OSS SDK和临时凭证上传文件。该凭证可重复使用，适用于文件分片传输或断点续传场景;</li>
<li><strong>表单上传机制</strong>： 服务端生成签名（可设置有效期），主要用于限制客户端上传文件的属性信息，如文件大小、格式、上传路径等。客户端使用签名信息，无需依赖OSS SDK，以Form表单形式上传文件。适用于需要限制上传文件属性的场景;</li>
<li><strong>第三方生成签名URL</strong>： 服务端生成签名URL（可设置有效期），返回给客户端。客户端通过调用签名URL上传文件。适用于简单上传场景。</li>
</ul>
<h3 id="41-sts临时访问凭证机制分析">4.1 STS临时访问凭证机制分析</h3>
<p>由于客户端调用OSS SDK上传文件时需携带服务端生成的STS临时凭证，因此存在STS临时凭证泄漏到前端页面的风险，如下图所示：</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be9.png" alt="img">
    <center><figcaption>图9. 客户端调用OSS SDK实现文件上传</figcaption></center>
  </figure>

</p>
<p>通过对STS临时凭证设置最小权限和最短有效期，可将泄漏风险降至最低。最小权限可仅限制为对对象存储的读或写权限，而最短有效期可在后端或控制台中进行设置。 笔者验证了STS临时凭证的最短有效期为15分钟，如图10所示：</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be10.png" alt="img">
    <center><figcaption>图10. STS临时凭证最小有效期限</figcaption></center>
  </figure>

</p>
<h3 id="42-表单上传机制分析">4.2 表单上传机制分析</h3>
<p>为了避免前端泄漏临时凭证信息，一种可行的方法是使用服务端生成签名的方式。这样，前端就无法通过签名获取具体的令牌信息了。以阿里云OSS的服务端生成PostObject签名和Post Policy为例，服务端生成签名所需的参数输入包括：</p>
<ul>
<li><strong>PostPolicy上传策略</strong>：用于限制文件属性</li>
<li><strong>策略过期时间</strong>：PostPolicy策略的过期时间，防止被重复使用</li>
<li><strong>SK凭证</strong>：云凭证信息</li>
</ul>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be11.png" alt="img">
    <center><figcaption>图11. 签名函数参数输入</figcaption></center>
  </figure>

</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be12.png" alt="img">
    <center><figcaption>图12. 签名函数</figcaption></center>
  </figure>

</p>
<p>PostPolicy文件上传策略是授权机制的核心，通常包含两部分内容：expiration（签名有效期）和conditions（约束条件）。如下图所示：</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be13.png" alt="img">
    <center><figcaption>图13. PostPolicy样例</figcaption></center>
  </figure>

</p>
<p>expiration限制了签名的有效时长，通过HMACSHA256哈希算法生成的加密字符串使SK凭证泄漏风险达到相对可控。</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be14.png" alt="img">
    <center><figcaption>图14. PostPolicy签名</figcaption></center>
  </figure>

</p>
<p>conditions用于限制文件上传属性，防止攻击者利用签名对对象存储进行恶意操作。为了更清晰的探讨此场景，笔者仍以阿里云OSS举例说明，假设有以下用户需求：</p>
<ol>
<li>
<p>文件上传至对象存储Test Bucket的“test1/”路径下；</p>
</li>
<li>
<p>文件格式为jpg或jpeg的图片，大小不超过1MB；</p>
</li>
<li>
<p>文件上传请求的Header中需包含x-oss-meta-prop的header key，值为“ssssss”;</p>
</li>
<li>
<p>同一文件不能重复上传；</p>
</li>
<li>
<p>签名有效期为1小时；</p>
</li>
</ol>
<p>用户尝试编写的策略如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">policy = {

​    \<span style="color:#6272a4"># 有效期。</span>

​    <span style="color:#ff79c6">&#34;expiration&#34;: </span>generate_expiration(<span style="color:#f1fa8c">&#34;3600&#34;</span>),

​    \<span style="color:#6272a4"># 约束条件，参考：https://help.aliyun.com/zh/oss/developer-reference/postobject。</span>

​    <span style="color:#ff79c6">&#34;conditions&#34;: </span>[

​      {<span style="color:#ff79c6">&#34;bucket&#34;: </span><span style="color:#f1fa8c">&#34;test&#34;</span> },

​      [<span style="color:#f1fa8c">&#34;eq&#34;</span>, <span style="color:#f1fa8c">&#34;$success_action_status&#34;</span>, <span style="color:#f1fa8c">&#34;200&#34;</span>],

​      [<span style="color:#f1fa8c">&#34;starts-with&#34;</span>, <span style="color:#f1fa8c">&#34;$key&#34;</span>, <span style="color:#f1fa8c">&#34;test1/&#34;</span>],

​      [<span style="color:#f1fa8c">&#34;content-length-range&#34;</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1000000</span>],

​      [<span style="color:#f1fa8c">&#34;in&#34;</span>, <span style="color:#f1fa8c">&#34;$content-type&#34;</span>, [<span style="color:#f1fa8c">&#34;image/jpg&#34;</span>, <span style="color:#f1fa8c">&#34;image/png&#34;</span>,<span style="color:#f1fa8c">&#34;image/jpeg&#34;</span>]],

​      [<span style="color:#f1fa8c">&#34;eq&#34;</span>,<span style="color:#f1fa8c">&#34;$x-oss-forbid-overwrite&#34;</span>,<span style="color:#f1fa8c">&#34;true&#34;</span>],

​      [<span style="color:#f1fa8c">&#34;starts-with&#34;</span>, <span style="color:#f1fa8c">&#34;$x-oss-meta-prop&#34;</span>, <span style="color:#f1fa8c">&#34;ssssss&#34;</span>],

​    ]

}
</code></pre></div><p>用户编写的策略应包含上述限制。服务端签名后，将Policy信息与SK凭证、签名过期时间传递至客户端。客户端通过Form表单上传文件。如下图所示：</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be15.png" alt="img">
    <center><figcaption>图15. 客户端表单上传</figcaption></center>
  </figure>

</p>
<p>若同一文件上传两次，OSS会验证策略匹配，并返回403无权限。如下图所示：</p>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be16.png" alt="img">
    <center><figcaption>图16. PostPolicy策略匹配错误提示</figcaption></center>
  </figure>

</p>
<p>由于有PostPolicy限制，该签名调用实际上是一次性的，即使攻击者拿到签名也只能在有限时间内执行一次操作，无法对其他文件做任何操作。即便用户未设置文件覆盖上传，攻击者对OSS发起DoS攻击，从云服务商责任划分原则上来看，用户自身通常不会承担安全风险，云服务商应具备抵御DoS攻击的能力。因此笔者认为该方法可以有效控制临时凭证的泄漏风险，并同时保护了对象存储系统的安全性。</p>
<h3 id="43-第三方生成签名url机制分析">4.3 第三方生成签名URL机制分析</h3>
<p>第三方生成签名URL机制可通过服务端生成一段具有有效期限的URL实现，客户端通过服务端返回的URL发起PUT请求来上传文件。签名URL的输入包括：</p>
<ul>
<li>上传对象名（Object）</li>
<li>指定Headers（用于限制文件属性，如Content-Type限制文件类型）</li>
<li>签名过期时间（expire_time）</li>
</ul>
<p>
  <figure>
    <img src="/img/%e5%ae%a2%e6%88%b7%e7%ab%af%e6%96%87%e4%bb%b6%e7%9b%b4%e4%bc%a0%e5%af%b9%e8%b1%a1%e5%ad%98%e5%82%a8%e7%9a%84%e4%be%bf%e6%8d%b7%e4%b8%8e%e5%ae%89%e5%85%a8%e6%80%a7%e6%8e%a2%e7%a9%b6/%e5%9b%be17.png" alt="img">
    <center><figcaption>图17. 签名URL输入参数</figcaption></center>
  </figure>

</p>
<p>经过服务端签名后的URL格式为：</p>
<p><a href="https://xxxx.oss-cn-xxxx.aliyuncs.com/test1/xxxx.png?OSSAccessKeyId=xxxx&amp;Expires=xxxx&amp;Signature=xxxx">https://xxxx.oss-cn-xxxx.aliyuncs.com/test1/xxxx.png?OSSAccessKeyId=xxxx&amp;Expires=xxxx&amp;Signature=xxxx</a></p>
<p>由于URL中的Signature值经过加密，客户端可以在不透露AK/SK访问凭证的情况下，授予第三方在特定有效期内对OSS资源的访问权限。此外，客户端无需依赖OSS SDK即可实现文件上传。</p>
<h2 id="五---延伸思考">五.   延伸思考</h2>
<h3 id="51-对象存储的文件上传流量几乎是免费的而文件下载流量和存储大小是付费的">5.1 对象存储的文件上传流量几乎是免费的，而文件下载流量和存储大小是付费的</h3>
<p>除非使用传输加速功能[3]，对象存储的文件上传流量通常是免费的。用户在限制文件大小和上传路径的前提下，如果攻击者获取了用户的云凭证并持续上传文件至对象存储，用户是无需为上传文件的流量付费的，但云服务商需要对攻击流量进行有效防御。</p>
<p>从便捷性和成本效益的角度考虑，用户可尽量避免使用公网流量下载文件，而应该利用云内网通道在同一Region内进行文件下载。例如用户购买的对象存储服务和云服务器位于同一Region，则可通过内网通道免费将对象存储中的数据下载至云服务器上，进行具体业务处理，最后再上传至对象存储。需注意的是, 同一Region的云服务器和对象存储之间内网互通，不同Region则不能。</p>
<p>此外，云提供商通常提供对象存储挂载云服务器的功能，如阿里云的OSS Bucket可以以目录的方式挂载至ECS实例[4]。</p>
<p>进一步的优化方式可以通过部署Serverless函数实现免费文件下载，这种方式的优势在于Serverless函数通常具有免费调用额度，并且具备较好的并发能力，可支持多租户上传。</p>
<h3 id="52-云租户持续的犯错将导致大量数据泄漏事件的发生">5.2 云租户持续的犯错将导致大量数据泄漏事件的发生</h3>
<p>过去一年期间，云安全领域涌现了一系列重大事件，例如：</p>
<ul>
<li>
<p>2023年1月，Wiz发现了Azure Active Directory（AAD）中的一个新攻击向量，影响Microsoft的Bing服务。该攻击向量基于常见的AAD配置错误，使得配置错误的应用程序允许未授权的访问[6]；</p>
</li>
<li>
<p>2023年2月21日，美国在线新闻网站TechCrunch报道称，美国国防部的一个服务器泄露了约3TB美国军方内部电子邮件数据。该服务器托管在微软为国防部提供的Azure政务云上，理论上该政务云与其他网络是物理隔离的，很可能是由于错误配置导致邮件服务暴露在了互联网中并且允许匿名访问[7]；</p>
</li>
<li>
<p>2023年5月12日，Toyota Connected Corporation（以下简称TC）宣布，丰田汽车公司外包给TC公司的部分数据因云环境设置不正确而遭到泄露。此次数据泄露事件影响约215万订阅丰田服务T-Connect、G-Link、G-Link Lite和G-BOOK的用户，泄露的信息包含车辆的位置信息、车辆在上述位置的时间以及车载终端ID和车辆识别号VIN，甚至包含2016年11月14日至2023年4月4日期间行车记录仪拍到的录像视频[8]；</p>
</li>
<li>
<p>2023年11月15日，Cabernets披露英国MPD FM（之前称为Manpower Direct）使用的亚马逊S3 (Simple Storage Service) 对象存储由于错误配置泄露了16,000 多份包含员工护照、签证、身份证、驾驶执照等敏感数据文件[9]。</p>
</li>
</ul>
<p>以上事件我们可以看出云租户会持续犯错，或是因为云服务访问错误配置，或是因为云凭证被误泄露在了公网上，这些均会导致安全事件的发生。绿盟科技在云上风险发现领域已有多年研究积累，研究发现泄漏数据对象的类型较多，典型的如源代码仓库、容器镜像仓库、云数据库、对象存储等。绿盟科技近期发布了《2023年公有云安全风险分析报告》[5]，报告针对公有云服务配置错误、云服务自身脆弱性配置或漏洞以及云服务的第三方供应链软件三方面进行了总结分析。此外，绿盟在能力侧也独家发现了全国多个系统源代码暴露情况 — 超四百万公民个人隐私信息存在泄露风险，这些安全事件均已上报至相关监管机构，从而真正做到了先于攻击者发现云上风险。</p>
<h2 id="六---总结">六.   总结</h2>
<p>本文分析了客户端直传文件至对象存储的便捷性及其面临的安全风险，并探讨了云服务商提供的文件“直传”安全机制的利弊。最后，提出了一些延伸思考，欢迎各位读者批评指正。</p>
<h2 id="七---参考文献">七.   参考文献</h2>
<p>[1] <a href="https://help.aliyun.com/zh/oss/user-guide/upload-objects-to-oss/?spm=a2c4g.11186623.0.0.6b5e6075UQumb8">https://help.aliyun.com/zh/oss/user-guide/upload-objects-to-oss/?spm=a2c4g.11186623.0.0.6b5e6075UQumb8</a></p>
<p>[2] <a href="https://help.aliyun.com/zh/ram/developer-reference/api-sts-2015-04-01-assumerole?spm=a2c4g.11186623.0.i155#main-107864">https://help.aliyun.com/zh/ram/developer-reference/api-sts-2015-04-01-assumerole?spm=a2c4g.11186623.0.i155#main-107864</a></p>
<p>[3] <a href="https://help.aliyun.com/zh/oss/user-guide/enable-transfer-acceleration">https://help.aliyun.com/zh/oss/user-guide/enable-transfer-acceleration</a></p>
<p>[4] <a href="https://help.aliyun.com/zh/oss/user-guide/methods-to-attach-an-oss-directory-to-an-ecs-instance?spm=5176.22414175.sslink.1.303c4e90pjaRdq">https://help.aliyun.com/zh/oss/user-guide/methods-to-attach-an-oss-directory-to-an-ecs-instance?spm=5176.22414175.sslink.1.303c4e90pjaRdq</a></p>
<p>[5] <a href="https://www.nsfocus.com.cn/html/2024/92_0313/212.html">https://www.nsfocus.com.cn/html/2024/92_0313/212.html</a></p>
<p>[6] <a href="https://www.wiz.io/blog/bingbang">https://www.wiz.io/blog/bingbang</a></p>
<p>[7] <a href="https://techcrunch.com/2023/02/21/sensitive-united-states-military-emails-spill-online/">https://techcrunch.com/2023/02/21/sensitive-united-states-military-emails-spill-online/</a></p>
<p>[8] <a href="https://company.toyotaconnected.co.jp/news/press/2023/0512/">https://company.toyotaconnected.co.jp/news/press/2023/0512/</a></p>
<p>[9] <a href="https://cybernews.com/security/mpd-fm-passport-data-leak/">https://cybernews.com/security/mpd-fm-passport-data-leak/</a></p>
<p>[10] <a href="https://www.zhihu.com/question/461803154/answer/3178042223">https://www.zhihu.com/question/461803154/answer/3178042223</a></p>


                
                
<div class="entry-shang text-center">
    
	    <p>「真诚赞赏，手留余香」</p>
	
	<button class="zs show-zs btn btn-bred">赞赏支持</button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">×</button>
		<span class="author"><a href="https://puming.zone">Ming Blog</a></span>
        
	        <p class="tip"><i></i><span>真诚赞赏，手留余香</span></p>
		
 
	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="1">1元</button>
			<button class="btn btn-blink" data-num="2">2元</button>
			<button class="btn btn-blink" data-num="5">5元</button>
			<button class="btn btn-blink" data-num="10">10元</button>
			<button class="btn btn-blink" data-num="30">30元</button>
			<button class="btn btn-blink" data-num="50">50元</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2元</button>
			<img src="/img/reward/wechat-2.png"  id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
		<label><input type="radio" name="zs-type" value="wechat" class="zs-type" checked="checked"><span ><span class="zs-wechat"><img src="/img/reward/wechat-btn.png"/></span></label>
		<label><input type="radio" name="zs-type" value="alipay" class="zs-type" class="zs-alipay"><img src="/img/reward/alipay-btn.png"/></span></label>
	</div>
</div>
<script type="text/javascript" src="/js/reward.js"></script>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/2024-02-18-%E6%97%A0%E9%A2%98/" data-toggle="tooltip" data-placement="top" title="无题">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/2024-04-20-%E9%82%A3%E4%BA%9B%E5%B9%B4%E9%99%AA%E8%87%AA%E5%B7%B1%E8%B5%B0%E8%BF%87%E7%9A%84%E6%AD%8C%E5%A3%B0/" data-toggle="tooltip" data-placement="top" title="那些年陪自己走过的歌声">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/anan" title="anan">
                            anan
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/api-gateway" title="api-gateway">
                            api-gateway
                        </a>
                        
                        
                        
                        <a href="/tags/api-security" title="api-security">
                            api-security
                        </a>
                        
                        
                        
                        <a href="/tags/api%E5%AE%89%E5%85%A8" title="api安全">
                            api安全
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/application" title="application">
                            application
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/cloud-native" title="cloud-native">
                            cloud-native
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/devops" title="devops">
                            devops
                        </a>
                        
                        
                        
                        <a href="/tags/devsecops" title="devsecops">
                            devsecops
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/kubernetes" title="kubernetes">
                            kubernetes
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/life" title="life">
                            life
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/netease-cloud-music" title="netease-cloud-music">
                            netease-cloud-music
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/offensive-and-defensive" title="offensive-and-defensive">
                            offensive-and-defensive
                        </a>
                        
                        
                        
                        <a href="/tags/photography" title="photography">
                            photography
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/rsa" title="rsa">
                            rsa
                        </a>
                        
                        
                        
                        <a href="/tags/saas" title="saas">
                            saas
                        </a>
                        
                        
                        
                        <a href="/tags/security" title="security">
                            security
                        </a>
                        
                        
                        
                        <a href="/tags/serverless" title="serverless">
                            serverless
                        </a>
                        
                        
                        
                        <a href="/tags/service-mesh" title="service-mesh">
                            service-mesh
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8" title="云原生安全">
                            云原生安全
                        </a>
                        
                        
                        
                        <a href="/tags/%E4%BA%91%E5%AE%89%E5%85%A8" title="云安全">
                            云安全
                        </a>
                        
                        
                        
                        <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97" title="云计算">
                            云计算
                        </a>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <a href="/tags/%E7%BD%91%E7%BB%9C%E7%A9%BA%E9%97%B4%E6%B5%8B%E7%BB%98" title="网络空间测绘">
                            网络空间测绘
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="Ming Blog" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
                   
                    
                    <li>
                        <a href="mailto:pumingdrinkcola@gmail.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    

                    
                    <li>
                        <a href="https://twitter.com/puming4">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    

                    

		    
                    
                    <li>
                        <a target="_blank" href="/img/wechat_qrcode.jpg">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://github.com/CalbeeMing0530">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/%E6%98%8E-%E6%B5%A6-1798a3162/">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    
                    
            
            
            <li>
                <a target="_blank" href="https://www.instagram.com/calbeeming/">
                    <span class="fa-stack fa-lg">
                        <i class="fas fa-circle fa-stack-2x"></i>
                        <i class="fab fa-instagram fa-stack-1x fa-inverse"></i>
                    </span>
                </a>
            </li>
            
            
                </ul>
		<p class="copyright text-muted">
		    Copyright © Ming Blog 2023
                    <br>
                    
<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>









<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>


</body>
</html>
